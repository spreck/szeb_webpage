
services:
  cone-app:
    build:
      context: .
      dockerfile: Dockerfile
    networks:
      - nginx-network
    environment:
      - FLASK_ENV=development
      - GEOSERVER_URL=https://conescout.duckdns.org/geoserver
      - SECRET_KEY=conescout_secret_key_2023
      - SECURITY_PASSWORD_SALT=conescout_salt_2023
      - ADMIN_EMAILS=jpwhitney@ucdavis.edu,jwingnut@gmail.com,admin@conescout.local
      - SQLALCHEMY_DATABASE_URI=postgresql://geoserver:23vmoWpostgis@postgis:5432/geoserver_db
    volumes:
      - ./templates:/usr/src/app/templates
      - ./static:/usr/src/app/static
      - ./app_updated_oauth.py:/usr/src/app/app.py
      - ./routes.py:/usr/src/app/routes.py
      - ./routes_auth.py:/usr/src/app/routes_auth.py
      - ./auth.py:/usr/src/app/auth.py
      - ./auth_routes.py:/usr/src/app/auth_routes.py
      - ./admin_routes.py:/usr/src/app/admin_routes.py
      - ./models.py:/usr/src/app/models.py
      - ./utils:/usr/src/app/utils
      - ./api:/usr/src/app/api
      - ./client_secret_509773047187-ug65ufnta7ikjrtjmct8aks6rgs0in4d.apps.googleusercontent.com.json:/usr/src/app/client_secret_509773047187-ug65ufnta7ikjrtjmct8aks6rgs0in4d.apps.googleusercontent.com.json
    depends_on:
      - postgis
    restart: always
    ports:
      - "8000:8000"
    mem_limit: 256M
    mem_reservation: 128M

  nginx-container:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    image: custom-nginx
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - cone-app
      - geoserver
    networks:
      - nginx-network
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/proxy_params:/etc/nginx/proxy_params:ro
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    restart: always
    mem_limit: 128M
    mem_reservation: 64M

  certbot-init:
    image: certbot/certbot
    profiles:
      - init
    depends_on:
      - nginx-container
    entrypoint: >
      certbot certonly --webroot --webroot-path=/var/www/certbot
      --email conescout.alerts@gmail.com
      --agree-tos --no-eff-email
      -d conescout.duckdns.org
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot


  certbot:
    image: certbot/certbot
    command: >
      sh -c "trap exit TERM; while :; do
        certbot renew --webroot -w /var/www/certbot --quiet &&
        nginx -s reload;
        sleep 12h & wait $${!};
      done"
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    depends_on:
      - nginx-container

  geoserver:
    image: docker.osgeo.org/geoserver:2.26.2
    environment:
      - POSTGRES_DB=geoserver_db
      - POSTGRES_USER=geoserver
      - POSTGRES_PASSWORD=23vmoWpostgis
      - PGHOST=postgis
      - PGPORT=5432
      - INSTALL_EXTENSIONS=true
      - SKIP_DEMO_DATA=true
      - GEOWEBCACHE_CACHE_DIR=/opt/geoserver_data/gwc
      - GEOWEBCACHE_CONFIG_DIR=/opt/geoserver_data/gwc
      - GEOWEBCACHE_CACHE_MEMORY=256M
      - GEOWEBCACHE_METASTORE_JDBC_HOST=postgis
      - GEOWEBCACHE_METASTORE_JDBC_PORT=5432
      - GEOWEBCACHE_METASTORE_JDBC_DATABASE=geoserver_db
      - GEOWEBCACHE_METASTORE_JDBC_USER=geoserver
      - GEOWEBCACHE_METASTORE_JDBC_PASSWORD=23vmoWpostgis
      - JAVA_OPTS=-Xms256M -Xmx512M -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+UseStringDeduplication
      - CATALINA_OPTS=-Xms256M -Xmx512M
      - GEOSERVER_OPTS=-DGEOSERVER_CSRF_DISABLED=true -Dorg.geotools.referencing.forceXY=true -Dorg.geotools.coverage.jaiext.enabled=true -DMAX_FEATURES=2000
      - STABLE_EXTENSIONS=ysld,h2,importer,vectortiles,monitor,css,rat,wps
      - COMMUNITY_EXTENSIONS=
      - ENABLE_JSONP=true
      - MAX_FILTER_RULES=20
      - OPTIMIZE_LINE_WIDTH=false
    volumes:
      - geoserver-extensions:/opt/additional_libs
      - P:/Projects/szeb_geoserver_data:/opt/geoserver_data
    networks:
      - nginx-network
    depends_on:
      - postgis
    ports:
      - "8080:8080"
    restart: always
    mem_limit: 768M
    mem_reservation: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  postgis:
    build:
      context: ./postgis
      dockerfile: Dockerfile
    container_name: postgis_container
    environment:
      - POSTGRES_DB=geoserver_db
      - POSTGRES_USER=geoserver
      - POSTGRES_PASSWORD=23vmoWpostgis
      - PGDATA=/var/lib/postgresql/data
      - POSTGRES_SHARED_BUFFERS=256MB
      - POSTGRES_EFFECTIVE_CACHE_SIZE=512MB
      - POSTGRES_WORK_MEM=16MB
      - POSTGRES_MAINTENANCE_WORK_MEM=64MB
      - POSTGRES_RANDOM_PAGE_COST=2.0
      - POSTGRES_EFFECTIVE_IO_CONCURRENCY=50
      - GDAL_DATA=/usr/share/gdal
      - PROJ_LIB=/usr/share/proj
      - LD_LIBRARY_PATH=/usr/lib:/usr/lib/postgresql:/usr/lib/x86_64-linux-gnu:/usr/local/lib
    volumes:
      - I:/postgis_storage:/var/lib/postgresql/data
      - P:/Projects/szeb_geoserver_data:/opt/geoserver_data
    shm_size: '256mb'
    networks:
      - nginx-network
    ports:
      - "5432:5432"
    cpus: '2'
    mem_limit: 768M
    mem_reservation: 512M
    restart: always

networks:
  nginx-network:
    driver: bridge

volumes:
  geoserver-extensions:
    external: true
  postgis-data:
    driver: local
